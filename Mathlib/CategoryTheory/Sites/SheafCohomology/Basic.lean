/-
Copyright (c) 2024 Jo√´l Riou. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: Jo√´l Riou
-/
import Mathlib.Algebra.Category.Grp.Abelian
import Mathlib.Algebra.Category.Grp.Adjunctions
import Mathlib.Algebra.Homology.DerivedCategory.Ext.Basic
import Mathlib.AlgebraicTopology.AlternatingFaceMapComplex
import Mathlib.AlgebraicTopology.CechNerve
import Mathlib.CategoryTheory.Sites.Abelian
import Mathlib.CategoryTheory.Sites.ConstantSheaf

/-!
# Sheaf cohomology

Let `C` be a category equipped with a Grothendieck topology `J`.
We define the cohomology types `Sheaf.H F n` of an abelian
sheaf `F` on the site `(C, J)` for all `n : ‚Ñï`. These abelian
groups are defined as the `Ext`-groups from the constant abelian
sheaf with values `‚Ñ§` (actually `ULift ‚Ñ§`) to `F`.

We also define `Sheaf.cohomologyPresheaf F n : C·µí·µñ ‚•§ AddCommGrp`
which is the presheaf which sends `U` to the `n`th `Ext`-group
from the free abelian sheaf generated by the presheaf
of sets `yoneda.obj U` to `F`.

## TODO
* if `U` is a terminal object of `C`, define an isomorphism
`(F.cohomologyPresheaf n).obj (Opposite.op U) ‚âÉ+ Sheaf.H F n`.
* if `U : C`, define an isomorphism
`(F.cohomologyPresheaf n).obj (Opposite.op U) ‚âÉ+ Sheaf.H (F.over U) n`.

-/

assert_not_exists TwoSidedIdeal

universe w' w v u

namespace CategoryTheory

open Abelian

variable {C : Type u} [Category.{v} C] {J : GrothendieckTopology C}

namespace Sheaf

section

variable (F : Sheaf J AddCommGrp.{w})
  [HasSheafify J AddCommGrp.{w}] [HasExt.{w'} (Sheaf J AddCommGrp.{w})]

/-- The cohomology of an abelian sheaf in degree `n`. -/
def H (n : ‚Ñï) : Type w' :=
  Ext ((constantSheaf J AddCommGrp.{w}).obj (AddCommGrp.of (ULift ‚Ñ§))) F n

noncomputable instance (n : ‚Ñï) : AddCommGroup (F.H n) := by
  dsimp only [H]
  infer_instance

end

section

variable [HasSheafify J AddCommGrp.{v}] [HasExt.{w'} (Sheaf J AddCommGrp.{v})]

variable (J) in
/-- The bifunctor which sends an abelian sheaf `F` and an object `U` to the
`n`th Ext-group from the free abelian sheaf generated by the
presheaf of sets `yoneda.obj U` to `F`. -/
noncomputable def cohomologyPresheafFunctor (n : ‚Ñï) :
    Sheaf J AddCommGrp.{v} ‚•§ C·µí·µñ ‚•§ AddCommGrp.{w'} :=
  Functor.flip
    (Functor.op (yoneda ‚ãô (whiskeringRight _ _ _).obj
      AddCommGrp.free ‚ãô presheafToSheaf _ _) ‚ãô extFunctor n)

/-- Given an abelian sheaf `F`, this is the presheaf which sends `U`
to the `n`th Ext-group from the free abelian sheaf generated by the
presheaf of sets `yoneda.obj U` to `F`. -/
noncomputable abbrev cohomologyPresheaf (F : Sheaf J AddCommGrp.{v}) (n : ‚Ñï) :
    C·µí·µñ ‚•§ AddCommGrp.{w'} :=
  (cohomologyPresheafFunctor J n).obj F

end


open Limits

noncomputable
def _root_.CategoryTheory.Presieve.asMorphism (X : C) (S : Presieve X) [HasColimit S.diagram]: colimit S.diagram ‚ü∂ X :=
  colimit.desc S.diagram ‚ü®_, fun f => f.obj.hom, by aesop_cat‚ü©

def Cech.complex (F : Sheaf J AddCommGrp.{v}) (X : C) (ùí∞ : J X) : CochainComplex AddCommGrp ‚Ñï :=
  (AlgebraicTopology.alternatingCofaceMapComplex _).obj <|
    Functor.rightOp (Arrow.cechNerve <| ùí∞.val.arrows.asMorphism) ‚ãô
      _

#check whiskeringRight
#check Arrow.cechNerve

end Sheaf

end CategoryTheory
